services:
  web:
    build:
      context: .
      dockerfile: Containerfile
    ports:
      - "3000:80"
    environment:
      - RAILS_ENV=production
      # RAILS_MASTER_KEY must be set via .env file or environment variable
      # Create .env file with: echo "RAILS_MASTER_KEY=$(cat config/master.key)" > .env
      - RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
    env_file:
      # Load RAILS_MASTER_KEY from .env file if it exists
      - .env
    volumes:
      # Mount storage directory for SQLite databases and Active Storage files
      # This directory contains:
      # - production.sqlite3 (primary database)
      # - production_cache.sqlite3 (cache database)
      # - production_queue.sqlite3 (queue database)
      # - production_cable.sqlite3 (cable database)
      # - Active Storage uploads
      - ./data:/rails/storage
    # Use Thruster for better performance (as configured in Containerfile)
    # Override with: docker-compose run gitrack-web ./bin/rails server -b 0.0.0.0 -p 80
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

