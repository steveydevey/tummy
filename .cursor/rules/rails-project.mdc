---
description: Rails Project Standards
globs: ["**/*.rb", "**/*.erb", "**/*.js"]
---

# Rails Project Standards

## Code Style

- Follow Ruby style guide (https://rubystyle.guide/)
- Use 2 spaces for indentation
- Prefer single quotes for strings unless interpolation needed
- Use meaningful variable and method names
- Keep methods small and focused (single responsibility)

## Testing Requirements

- **ALL code must have tests**
- Write tests before implementation (TDD)
- Test coverage target: 90%+
- Use RSpec for testing
- Use FactoryBot for test data
- Test models, controllers, and integrations

## Model Guidelines

- Keep models thin (business logic only)
- Use validations for data integrity
- Use scopes for common queries
- Always scope queries to current_user for multi-user data
- Use `dependent: :destroy` or `dependent: :delete_all` appropriately

## Controller Guidelines

- Keep controllers thin (delegate to models/services)
- Use strong parameters
- Always authenticate users (before_action :authenticate_user!)
- Scope all queries to current_user
- Use standard RESTful actions
- Return appropriate HTTP status codes

## Security

- Never trust user input - always validate
- Always scope database queries to current_user
- Use Rails CSRF protection (enabled by default)
- Use strong parameters for mass assignment
- Never expose user data to other users

## Database

- Use migrations for all schema changes
- Add indexes for foreign keys and frequently queried columns
- Use timestamps (created_at, updated_at) on all models
- Use appropriate data types

## Git Workflow

- Write meaningful commit messages
- Commit related changes together
- Test before committing
- Keep commits focused and atomic

## JavaScript & Frontend

- **Turbo Rails**: Application uses Turbo for SPA-like navigation
- **Importmap**: JavaScript dependencies managed via importmap (no webpack/esbuild)
- **Turbo Setup**: 
  - Turbo is configured in `app/javascript/application.js`
  - Layout includes `javascript_importmap_tags` in `<head>`
  - Use `data: { turbo_method: :delete }` for delete links, not `method: :delete`
  - Listen for both `DOMContentLoaded` and `turbo:load` events for page loads
- **Datetime Autopopulation**: 
  - All `datetime-local` fields auto-populate with current browser time if empty
  - Handled in `app/javascript/application.js` via `autopopulateDatetimeFields()` function
  - Works on both initial load and Turbo navigation

## View Patterns

- **Date Formatting**: Use human-readable format: `strftime("%b %d, %Y at %l:%M %p").strip`
  - Example: "Jan 15, 2024 at 2:30 PM"
- **Table Styling**:
  - Food entries: Light green background `#E8F5E9`
  - GI symptoms: Light blue background `#E3F2FD`
  - Bowel movements: Light purple background `#F3E5F5`
- **Clickable Rows**: Use `onclick="window.location.href='...'"` with `cursor: pointer` style
- **Severity Display**:
  - GI symptoms: Show in description as "Symptom Type - Severity/10" (e.g., "Nausea - 7/10")
  - Bowel movements: Show as "Severity - Term" (e.g., "3 - Logs")
  - No separate severity columns in tables
- **Return To Navigation**: All edit forms use `return_to` parameter for navigation context
  - Use `sanitize_return_to()` helper method in controllers
  - Pass `return_to: request.url` when linking to edit forms

## Documentation

- Document complex logic with comments
- Keep README updated
- Document API endpoints if applicable
- Update PROJECT_PLAN.md as features are completed
